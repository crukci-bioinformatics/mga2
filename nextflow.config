
manifest {
    name = 'crukci-bioinformatics/mga2'
    author = 'Matt Eldridge'
    homePage = 'https://github.com/crukci-bioinformatics/mga'
    description = 'Multi-Genome Alignment (MGA) contaminant screen for genomic sequencing data'
    mainScript = 'mga2.nf'
    nextflowVersion = '>=20.10.0'
    version = '2.0.0'
}

process {
    container = 'crukcibioinformatics/mga2'
    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'terminate' }
    cpus = 1
    memory = 1.GB
    time = 1.hour

    withName: check_inputs {
        executor = 'local'
    }

    withName: sample_fastq {
        time = { 2.hour * 2 ** (task.attempt - 1) }
        maxRetries = 2
    }

    withName: trim_and_split {
        executor = 'local'
    }

    withName: bowtie {
        memory = { 4.GB * 2 ** (task.attempt - 1) }
        time = { 2.hour * 2 ** (task.attempt - 1) }
        maxRetries = 2
    }

    withName: create_summary {
        memory = 2.GB
        memory = { 2.GB * task.attempt }
        maxRetries = 2
    }
}

docker {
    runOptions = "-v '${projectDir}:${projectDir}'"
}

singularity {
    autoMounts = true
    runOptions = "--bind '${projectDir}'"
    cacheDir = "${launchDir}"
}

profiles {
    standard {
        process.executor = 'local'
        executor {
            cpus = 4
            memory = 16.GB
        }
    }

    bigserver {
        process.executor = 'local'
        executor {
            cpus = 30
            memory = 128.GB
        }
    }

    cluster {
        process.executor = 'slurm'
        executor {
            queueSize = 50
            pollInterval = 30.sec
            jobName = { "'$task.name'" }
        }
    }
}

// additional run configuration
try
{
    includeConfig "${launchDir}/mga2.config"
}
catch (java.nio.file.NoSuchFileException e) {}

